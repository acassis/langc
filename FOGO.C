
//Codigo de Aaron Clemmer alterado!

#include <stdio.h>
#include <stdlib.h>
#include <conio.h>

void set_mx();
void set_pal();
void flame();
void dump2con();
void b4exit();

char x1 = 0, x2 = 1, x3 = -1, x4 = 1, x5 = -1;
char y1 = -1, y2 = 0, y3 = 0, y4 = 1, y5 = 1;
int de = 1, ate = 2;
int escuro = 2;
int current[56][80], working[56][80];
unsigned char pal[768]={   0,  0,  0,  0,  0, 0,  0,  0, 24,  0,  0, 28,
			   0,  0, 32,  0,  0, 32,  0,  0, 36,  0,  0, 40,
			   8,  0, 40, 16,  0, 36, 24,  0, 36, 32,  0, 32,
			  40,  0, 28, 48,  0, 28, 56,  0, 24, 64,  0, 20,
			  72,  0, 20, 80,  0, 16, 88,  0, 16, 96,  0, 12,
			 104,  0,  8,112,  0,  8,120,  0,  4,128,  0,  0,
			 128,  0,  0,132,  0,  0,136,  0,  0,140,  0,  0,
			 144,  0,  0,144,  0,  0,148,  0,  0,152,  0,  0,
			 156,  0,  0,160,  0,  0,160,  0,  0,164,  0,  0,
			 168,  0,  0,172,  0,  0,176,  0,  0,180,  0,  0,
			 184,  4,  0,188,  4,  0,192,  8,  0,196,  8,  0,
			 200, 12,  0,204, 12,  0,208, 16,  0,212, 16,  0,
			 216, 20,  0,220, 20,  0,224, 24,  0,228, 24,  0,
			 232, 28,  0,236, 28,  0,240, 32,  0,244, 32,  0,
			 252, 36,  0,252, 36,  0,252, 40,  0,252, 40,  0,
			 252, 44,  0,252, 44,  0,252, 48,  0,252, 48,  0,
			 252, 52,  0,252, 52,  0,252, 56,  0,252, 56,  0,
			 252, 60,  0,252, 60,  0,252, 64,  0,252, 64,  0,
			 252, 68,  0,252, 68,  0,252, 72,  0,252, 72,  0,
			 252, 76,  0,252, 76,  0,252, 80,  0,252, 80,  0,
			 252, 84,  0,252, 84,  0,252, 88,  0,252, 88,  0,
			 252, 92,  0,252, 96,  0,252, 96,  0,252,100,  0,
			 252,100,  0,252,104,  0,252,104,  0,252,108,  0,
			 252,108,  0,252,112,  0,252,112,  0,252,116,  0,
			 252,116,  0,252,120,  0,252,120,  0,252,124,  0,
			 252,124,  0,252,128,  0,252,128,  0,252,132,  0,
			 252,132,  0,252,136,  0,252, 136,   0,252, 140,   0,
			 252, 140,   0,252, 144,   0,252, 144,   0,252, 148,   0,
			 252, 152,   0,252, 152,   0,252, 156,   0,252, 156,   0,
			 252, 160,   0,252, 160,   0,252, 164,   0,252, 164,   0,
			 252, 168,   0,252, 168,   0,252, 172,   0,252, 172,   0,
			 252, 176,   0,252, 176,   0,252, 180,   0,252, 180,   0,
			 252, 184,   0,252, 184,   0,252, 188,   0,252, 188,   0,
			 252, 192,   0,252, 192,   0,252, 196,   0,252, 196,   0,
			 252, 200,   0,252, 200,   0,252, 204,   0,252, 208,   0,
			 252, 208,   0,252, 208,   0,252, 208,   0,252, 208,   0,
			 252, 212,   0,252, 212,   0,252, 212,   0,252, 212,   0,
			 252, 216,   0,252, 216,   0,252, 216,   0,252, 216,   0,
			 252, 216,   0,252, 220,   0,252, 220,   0,252, 220,   0,
			 252, 220,   0,252, 224,   0,252, 224,   0,252, 224,   0,
			 252, 224,   0,252, 228,   0,252, 228,   0,252, 228,   0,
			 252, 228,   0,252, 228,   0,252, 232,   0,252, 232,   0,
			 252, 232,   0,252, 232,   0,252, 236,   0,252, 236,   0,
			 252, 236,   0,252, 236,   0,252, 240,   0,252, 240,   0,
			 252, 240,   0,252, 240,   0,252, 240,   0,252, 244,   0,
			 252, 244,   0,252, 244,   0,252, 244,   0,252, 248,   0,
			 252, 248,   0,252, 248,   0,252, 248,   0,252, 252,   0,
			 252, 252,   4,252, 252,   8,252, 252,  12,252, 252,  16,
			 252, 252,  20,252, 252,  24,252, 252,  28,252, 252,  32,
			 252, 252,  36,252, 252,  40,252, 252,  40,252, 252,  44,
			 252, 252,  48,252, 252,  52,252, 252,  56,252, 252,  60,
			 252, 252,  64,252, 252,  68,252, 252,  72,252, 252,  76,
			 252, 252,  80,252, 252,  84,252, 252,  84,252, 252,  88,
			 252, 252,  92,252, 252,  96,252, 252, 100,252, 252, 104,
			 252, 252, 108,252, 252, 112,252, 252, 116,252, 252, 120,
			 252, 252, 124,252, 252, 124,252, 252, 128,252, 252, 132,
			 252, 252, 136,252, 252, 140,252, 252, 144,252, 252, 148,
			 252, 252, 152,252, 252, 156,252, 252, 160,252, 252, 164,
			 252, 252, 168,252, 252, 168,252, 252, 172,252, 252, 176,
			 252, 252, 180,252, 252, 184,252, 252, 188,252, 252, 192,
			 252, 252, 196,252, 252, 200,252, 252, 204,252, 252, 208,
			 252, 252, 208,252, 252, 212,252, 252, 216,252, 252, 220,
			 252, 252, 224,252, 252, 228,252, 252, 232,252, 252, 236,
			 252, 252, 240,252, 252, 244,252, 252, 248,252, 252, 252};

int main()
{
 int x=0,y=0;

 set_mx();

 set_pal();

 for (y = 0; y <= 56; y++)
  {
   for (x = 0; x <= 80; x++)
    {
     current[y][x] = 0;
     working[y][x] = 0;
    }
  }

 do
  {
   flame(); //== Call the flame generator ==//
  } while (!kbhit());
   asm mov ax,3
   asm int 10
 return(0);
}


void flame()
{
 int delta=0,i=0,x=0,y=0; //== General loops ==//
 int cl1=0,cl2=0,cl3=0,cl4=0,cl5=0,cl6=0;  //== color vals used in averaging ==//

 for(i=0;i<80;i++)
  {
   if(random(10) < 5)
    {
     delta=random(2)*255 + 1;
    }
   working[55][i]=delta;
   working[56][i]=delta;
  }


 for (y = 55; y >= 2; y--)
  {
   for (x = 1; x <= 79; x++)
    {
     cl1 = current[y + y1][x + x1];
     cl2 = current[y + y2][x + x2];
     cl3 = current[y + y3][x + x3];
     cl4 = current[y + y4][x + x4];
     cl5 = current[y + y5][x + x5];
     cl6 = (cl1+cl2+cl3+cl4+cl5) /5;

     if (cl6 > de) cl6 -= ate;
     working[y-1][x] = cl6;
    }
  }


 for (y =0; y <= 56; y++)
  {
   for (x = 0; x <= 80; x++)
    {
     current[y][x] = working[y][x];
    }
  }


 dump2con();
}


void dump2con()
{

 _SI = (unsigned int)&current[0][0];
 asm mov di,0
 asm mov ax,0A000h
 asm mov es,ax
 asm mov cx,280*45

XF1:
 asm mov ax,ds:[si]
 asm add si,2
 asm mov dl,al
 asm mov ax,ds:[si]
 asm add si,2
 asm mov dh,al
 asm mov es:[di],dx
 asm add di,2
 asm dec cx
 asm jnz XF1
}


void set_pal()
{
 int  i;

 for(i=0;i<768;i++)
  {
   pal[i] = pal[i] >> escuro;
  }

 _SI = (unsigned int)&pal[0];
 asm mov cx,768
 asm mov dx,0x03c8
 asm xor al,al
 asm out dx,al
 asm inc dx
l1:
 asm outsb
 asm dec cx
 asm jnz l1
}


void set_mx(void)
{

 asm CLD
 asm MOV AX,13h
 asm INT 10h
 asm CLI
 asm MOV DX,3c4h
 asm MOV AX,604h // Unchain VGA
 asm OUT DX,AX
 asm MOV AX,0F02h // All planes
 asm OUT DX,AX

 asm MOV DX,3D4h
 asm MOV AX,14h // Disable dword mode
 asm OUT DX,AX
 asm MOV AX,0E317h // Enable byte mode.
 asm OUT DX,AX
 asm MOV AL,9
 asm OUT DX,AL
 asm INC DX
 asm IN  AL,DX
 asm AND AL,0E0h // Duplicate each scan 8 times.
 asm ADD AL,7
 asm OUT DX,AL
}


void b4exit()
{
 asm mov ax,03h
 asm int 10h
}
